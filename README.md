# llm-infer

åŸºäº vLLM å’Œ HuggingFace çš„å¤§æ¨¡å‹æ¨ç†æ¡†æ¶ï¼Œæ”¯æŒå¤šå¡å¤šè¿›ç¨‹æ•°æ®å¹¶è¡Œæ¨ç†ï¼Œæ”¯æŒè‡ªå®šä¹‰ä»»åŠ¡è¯»å–ã€æ ¼å¼åŒ–ä»¥åŠç­”æ¡ˆæå–ã€‚

## ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½æ¨ç†**: æ”¯æŒ vLLM å’Œ HuggingFace ä¸¤ç§æ¨ç†åç«¯
- ğŸ”„ **å¤šè¿›ç¨‹å¹¶è¡Œ**: æ”¯æŒå¤š GPU å¤šè¿›ç¨‹æ•°æ®å¹¶è¡Œæ¨ç†
- ğŸ“ **çµæ´»é…ç½®**: æ”¯æŒè‡ªå®šä¹‰ä»»åŠ¡é…ç½®ï¼ŒåŒ…æ‹¬æ•°æ®è¯»å–ã€æç¤ºè¯æ ¼å¼åŒ–å’Œç­”æ¡ˆæå–
- ğŸ’¾ **æ–­ç‚¹ç»­ä¼ **: æ”¯æŒä»»åŠ¡ä¸­æ–­åç»§ç»­æ‰§è¡Œ
- ğŸ“Š **è¯¦ç»†æ—¥å¿—**: æä¾›å®Œæ•´çš„æ¨ç†å’Œæå–æ—¥å¿—è®°å½•
- ğŸ–¥ï¸ **CPU/GPU æ”¯æŒ**: æ”¯æŒ CPU å’Œ GPU æ¨ç†æ¨¡å¼

## ç¯å¢ƒ

ä¸»è¦ä¾èµ–CUDA, pytorch, transformers, vllm

```bash
pip install -r requirements.txt
```

## å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ä½¿ç”¨

```bash
python main.py \
    --model_path /path/to/your/model \
    --model_type vllm \
    --output_path output \
    --task_name basic_example \
    --save_text
```

### 2. å¤š GPU å¹¶è¡Œæ¨ç†

```bash
export CUDA_VISIBLE_DEVICES=0,1,2,3
# workers * tensor_parallel_size = n_gpus

python main.py \
    --model_path /path/to/your/model \
    --model_type vllm \
    --output_path output \
    --task_name your_task \
    --tasks 4 \
    --workers 2 \
    --tensor_parallel_size 2
```

### 3. CPU æ¨ç†

```bash
python main.py \
    --model_path /path/to/your/model \
    --model_type hf \
    --use_cpu \
    --output_path output \
    --task_name your_task
```

## å‚æ•°è¯´æ˜

### åŸºæœ¬å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--model_path` | str | å¿…éœ€ | æ¨¡å‹è·¯å¾„ |
| `--model_type` | str | "vllm" | æ¨¡å‹ç±»å‹: "vllm" æˆ– "hf" |
| `--output_path` | str | å¿…éœ€ | è¾“å‡ºè·¯å¾„ |
| `--task_name` | str | å¿…éœ€ | ä»»åŠ¡é…ç½®åç§° |

### æ¨ç†å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--tasks` | int | 1 | ä»»åŠ¡æ•°é‡ï¼ˆæ‰€æœ‰è¾“å…¥å¹³å‡åˆ†é…ï¼Œæ¯ä¸ªä»»åŠ¡äº§ç”Ÿä¸€ä¸ªå­˜æ¡£ç‚¹ï¼‰ |
| `--workers` | int | 1 | å·¥ä½œè¿›ç¨‹æ•°ï¼ˆæ•°æ®å¹¶è¡Œæ•°é‡ï¼‰ |
| `--tensor_parallel_size` | int | 1 | å¼ é‡å¹¶è¡Œå¤§å°ï¼ˆæ¨¡å‹éœ€è¦å‡ å¼ å¡ï¼‰ |
| `--use_cpu` | flag | False | ä½¿ç”¨ CPU æ¨ç†ï¼ˆéœ€è¦model_type=hfï¼‰ |
| `--extract_only` | flag | False | ä¸ç”¨æ¨¡å‹æ¨ç†ï¼Œä»…æ‰§è¡Œç­”æ¡ˆæå– |
| `--rerun` | flag | False | éœ€è¦é‡æ–°è¿è¡Œå·²å®Œæˆçš„ä»»åŠ¡ |

éœ€è¦ä¿è¯workers * tensor_parallel_size $\leq$ CUDA_VISIBLE_DEVICESä¸­çš„GPUæ•°é‡

### è¾“å‡ºå‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--save_text` | flag | False | ä¿å­˜txtæ ¼å¼è¾“å‡ºï¼Œä¾¿äºè§‚å¯Ÿ |
| `--limit` | int | None | æ¯ä¸ªä»»åŠ¡åªä¿ç•™å‰limitæ¡æ•°æ®ï¼Œç”¨äºdebug |

## ä»»åŠ¡é…ç½®

æ¯ä¸ªä»»åŠ¡éœ€è¦åœ¨ `configs/` ç›®å½•ä¸‹åˆ›å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶å¤¹`your_task`ï¼ŒåŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼š

**å¿…éœ€æ–‡ä»¶ï¼š**

`task_config.py`: ä»»åŠ¡é…ç½®æ–‡ä»¶

**å¯é€‰æ–‡ä»¶ï¼š**

`sampling_params.json`: é‡‡æ ·å‚æ•°ï¼Œè‹¥ä¸å­˜åœ¨æˆ–ä¸åŒ…å«éƒ¨åˆ†å‚æ•°ï¼Œåˆ™ä¸åŒ…å«çš„éƒ¨åˆ†é‡‡ç”¨default_sampling_params.jsonä¸­çš„å‚æ•°

å…¶ä»–æ ¼å¼åŒ–promptæ‰€éœ€çš„æ–‡ä»¶...

### å¿…éœ€å‡½æ•°

åœ¨`task_config.py`ä¸­éœ€è¦å®ç°ä»¥ä¸‹å‡½æ•°ï¼Œå®ç°åï¼Œ`task.py`ä¸­çš„`get_tasks`å‡½æ•°ä¼šè·å–æ‰€æœ‰æ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶è¯»å–å…¶ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œç„¶åå¹³å‡åˆ†å‰²æˆå¤šä¸ªä»»åŠ¡ã€‚ï¼ˆæ³¨æ„ï¼Œä¸æ”¯æŒè¿­ä»£å¼è¯»å–ï¼Œè€ƒè™‘åˆ°æ¨ç†çš„æ•°æ®è§„æ¨¡é™åˆ¶ï¼Œæš‚æ—¶æ²¡æœ‰è¿­ä»£å¼è¯»å–çš„éœ€æ±‚ï¼‰

```python
def get_file_list(input_path: str) -> list[str]:
    """
    è¿”å›è¦å¤„ç†çš„æ–‡ä»¶åˆ—è¡¨ã€‚
    å‚æ•°:
        input_path (str): è¾“å…¥è·¯å¾„ï¼Œå¯èƒ½ä¸éœ€è¦ä½¿ç”¨ã€‚
    è¿”å›:
        list[str]: æ–‡ä»¶è·¯å¾„åˆ—è¡¨ã€‚
    """
    pass

def read_file(file_path: str) -> list[dict]:
    """
    è¯»å–æ–‡ä»¶å¹¶è¿”å›æ•°æ®åˆ—è¡¨ã€‚
    å‚æ•°:
        file_path (str): æ–‡ä»¶è·¯å¾„ã€‚
    è¿”å›:
        list[dict]: æ•°æ®å­—å…¸åˆ—è¡¨ï¼Œæ¯ä¸ªå­—å…¸åŒ…å«åŸå§‹æ•°æ®ã€‚
    """
    pass

def format_prompt(org_data: dict) -> str:
    """
    å°†åŸå§‹æ•°æ®æ ¼å¼åŒ–ä¸ºæç¤ºè¯ã€‚
    å‚æ•°:
        org_data (dict): åŸå§‹æ•°æ®å­—å…¸ã€‚
    è¿”å›:
        str: æ ¼å¼åŒ–åçš„æç¤ºè¯å­—ç¬¦ä¸²ã€‚
    """
    pass

def extract_answer(model_response: str):
    """
    ä»æ¨¡å‹å“åº”ä¸­æå–ç­”æ¡ˆï¼Œè‹¥æ— æ­¤éœ€æ±‚ï¼Œç›´æ¥è¿”å› Noneã€‚
    å‚æ•°:
        model_response (str): æ¨¡å‹ç”Ÿæˆçš„å“åº”ã€‚
    è¿”å›:
        æå–çš„ç­”æ¡ˆï¼Œå¦‚æœæå–å¤±è´¥è¿”å› Noneã€‚
    """
    pass
```

## è¾“å‡ºç»“æ„

```
output/
â”œâ”€â”€ args.json             # è¿è¡Œå‚æ•°
â”œâ”€â”€ logs/
â”‚   â”œâ”€â”€ main.log          # ä¸»ç¨‹åºæ—¥å¿—
â”‚   â”œâ”€â”€ tasks/            # ä»»åŠ¡æ—¥å¿—
â”‚   â””â”€â”€ completions/      # ä»»åŠ¡å®Œæˆæ ‡è®°
â””â”€â”€ results/
    â”œâ”€â”€ infer/            # æ¨ç†ç»“æœ
    â”œâ”€â”€ extract/          # æå–ç»“æœ
    â””â”€â”€ text/             # æ–‡æœ¬æ ¼å¼
```